document.addEventListener("DOMContentLoaded",()=>{!function e(){if(!window.libphonenumber){let t=document.createElement("script");t.src="https://cdn.jsdelivr.net/npm/libphonenumber-js@1.10.18/bundle/libphonenumber-max.js",document.head.appendChild(t)}}();let e="/api",t=document.createElement("div");function r(e,r="info"){let a=document.createElement("div");a.className=`toast toast-${r}`,Object.assign(a.style,{padding:"10px 14px",borderRadius:"6px",boxShadow:"0 6px 18px rgba(0,0,0,.15)",background:"success"===r?"#16a34a":"error"===r?"#dc2626":"warn"===r?"#d97706":"#334155",color:"#fff",opacity:"0",transform:"translateY(-6px)",transition:"all .25s ease"}),a.textContent=e,t.appendChild(a),requestAnimationFrame(()=>{a.style.opacity="1",a.style.transform="translateY(0)"}),setTimeout(()=>{a.style.opacity="0",a.style.transform="translateY(-6px)",setTimeout(()=>a.remove(),250)},3e3)}t.id="toast-container",Object.assign(t.style,{position:"fixed",right:"16px",top:"16px",zIndex:"9999",display:"flex",flexDirection:"column",gap:"8px"}),document.body.appendChild(t);let a=document.querySelector(".info-form"),i=document.querySelector(".login-form"),n=document.querySelector(".navbar"),s=document.getElementById("cart_sidebar"),o=document.querySelector(".cart_icon"),l=o?.querySelector("span"),c=document.querySelector(".cart_items"),d=document.querySelector(".cart_total"),p=document.getElementById("sidebar_close"),u=document.querySelectorAll(".btn_shop"),m=document.querySelector(".checkout_btn"),y=document.querySelector(".search-box input"),f=[],v=!1,g=!1;if(window.currentUser=null,i){i.querySelector("#checkout_name")||i.querySelector('input[name="name"]');let h=i.querySelector("#checkout_email")||i.querySelector('input[type="email"]'),b=document.createElement("div");function L(e,t=60){e.disabled=!0;let r=t,a=setInterval(()=>{e.textContent=`Resend (${r}s)`,--r<0&&(clearInterval(a),e.disabled=!1,e.textContent="Send Code")},1e3)}function S(){v=g,u.forEach(e=>e.disabled=!v),v&&r("You are now ready to shop!")}b.style.display="grid",b.style.gridTemplateColumns="1fr auto",b.style.gap="8px",b.style.marginTop="8px",b.style.height="80%",b.innerHTML=`
      <input id="email_otp" placeholder="Email 6-digit code" maxlength="6" style="padding:10px"/>
      <div style="display:flex; gap:8px">
        <button type="button" id="send_email_otp" class="btn-send">Send Code</button>
        <button type="button" id="verify_email_otp" class="btn-verify">Verify</button>
      </div>
    `,h?.parentNode?.insertBefore(b,h.nextSibling),[...i.querySelectorAll(".btn-send,.btn-verify")].forEach(e=>{Object.assign(e.style,{padding:"0px 6px",cursor:"pointer",fontSize:"8px",fontWeight:"bold",border:"none",borderRadius:"2px"}),e.classList.contains("btn-send")&&(e.style.background="#800080",e.style.color="#fff"),e.classList.contains("btn-verify")&&(e.style.background="green",e.style.color="#fff")}),i.querySelector("#send_email_otp")?.addEventListener("click",async()=>{let t=h?.value.trim();if(!t)return r("Enter your email first.","warn");try{let a=await fetch(`${e}/send-email-otp`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t})}),n=await a.json();a.ok?(r("Email code sent."),L(i.querySelector("#send_email_otp"))):r(n.error||"Failed to send email code.","error")}catch(s){console.error("Error sending email OTP:",s),r("Server error sending email code.","error")}}),i.querySelector("#verify_email_otp")?.addEventListener("click",async()=>{let t=i.querySelector("#email_otp")?.value.trim(),a=h?.value.trim();if(!a||!t)return r("Enter email & code.","warn");try{let n=await fetch(`${e}/verify-email-otp`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:a,code:t})}),s=await n.json();n.ok?(g=!0,r("Email verified ✅"),S()):r(s.error||"Invalid email code.","error")}catch(o){console.error("Error verifying email:",o),r("Server error verifying email.","error")}})}async function x(){if(v)try{let t=await fetch(`${e}/Cart`,{credentials:"include"}),r=await t.json();f=r.cart||r.items||[],$()}catch(a){console.error(a),f=[],$()}}function $(){if(!c||!d||!l)return;c.innerHTML="";let e=0;f.forEach((t,r)=>{let a=document.createElement("div");a.className="cart_item",a.innerHTML=`
        <p>${t.name} - $${Number(t.price||0).toLocaleString()}</p>
        <i class="fa-solid fa-trash remove-btn" data-index="${r}" style="cursor:pointer"></i>
      `,c.appendChild(a),e+=Number(t.price||0)}),d.textContent=`$${e.toLocaleString()}`,l.textContent=String(f.length)}async function E(){if(v)try{await fetch(`${e}/Cart`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({cart:f})})}catch(t){console.error(t)}}async function w(){try{await fetch(`${e}/Cart/clear`,{method:"POST",credentials:"include"})}catch(t){console.error(t)}}document.querySelector("#info-btn")?.addEventListener("click",()=>{a?.classList.toggle("active"),i?.classList.remove("active"),n?.classList.remove("active"),s?.classList.remove("open")}),document.querySelector("#login-btn")?.addEventListener("click",()=>{i?.classList.toggle("active"),a?.classList.remove("active"),n?.classList.remove("active"),s?.classList.remove("open")}),document.querySelector("#menu-btn")?.addEventListener("click",()=>{n?.classList.toggle("active"),i?.classList.remove("active"),a?.classList.remove("active"),s?.classList.remove("open")}),o?.addEventListener("click",()=>{if(!v)return r("Verify & signup first","error");s?.classList.toggle("open"),i?.classList.remove("active"),a?.classList.remove("active"),n?.classList.remove("active")}),p?.addEventListener("click",()=>{s?.classList.remove("open")}),window.addEventListener("scroll",()=>{i?.classList.remove("active"),a?.classList.remove("active"),n?.classList.remove("active"),s?.classList.remove("open")}),y?.addEventListener("input",function(){let e=this.value.toLowerCase();document.querySelectorAll(".cart_card").forEach(t=>{let r=t.querySelector(".card_title")?.innerText.toLowerCase()||"";t.style.display=r.includes(e)?"block":"none"})}),i?.addEventListener("submit",async t=>{t.preventDefault();let a=document.getElementById("checkout_name")?.value.trim(),n=document.getElementById("checkout_email")?.value.trim();if(!a||!n)return r("Fill all fields.","error");if(!g)return r("Verify email first.","warn");if(!/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(n)){r("Invalid email format. Please enter a valid email address (e.g. example@gmail.com)","error");return}try{let s=await fetch(`${e}/signup`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:a,email:n,emailVerified:!0})}),o=await s.json();s.ok?(v=!0,window.currentUser=o.user||{name:a,email:n},r("Signup complete "),i.classList.remove("active"),i.reset(),await x(),$()):r(o.error||"Signup failed.","error")}catch(l){console.error(l),r("Server error.","error")}}),u.forEach(t=>{t.addEventListener("click",async()=>{if(!v)return r("Verify & signup first","error");let a=t.closest(".cart_card"),i=a?.querySelector(".card_title")?.innerText||"Unnamed",n=parseFloat(a?.querySelector(".card_price")?.innerText.replace(/[^0-9.]/g,"")||"0"),s=a?.querySelector("img")?.getAttribute("src")||"",o=a?.getAttribute("data-id")||i.toLowerCase().replace(/\s+/g,"-"),l={name:i,price:n,image:s,id:o};f.push(l),$(),await E(),fetch(`${e}/userAction`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"add_to_cart",data:{...l,timestamp:new Date().toISOString(),userData:window.currentUser||{}}})})})}),c?.addEventListener("click",async e=>{if(e.target.classList.contains("remove-btn")){let t=parseInt(e.target.dataset.index);f.splice(t,1),$(),await E()}}),document.body.addEventListener("click",t=>{let r=t.target;if("BUTTON"===r.tagName||r.classList.contains("btn_shop")){let a={text:r.innerText.trim(),classes:r.className,timestamp:new Date().toISOString(),userData:window.currentUser||{}};fetch(`${e}/Log`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)})}}),m?.addEventListener("click",async()=>{if(0===f.length){r("Your cart is empty!","error");return}try{let t=await fetch(`${e}/Cart/clear`,{method:"POST",credentials:"include"});if(!t.ok)throw Error("Failed to clear cart");f=[],$(),s?.classList.remove("open"),r("✅ Checkout successful! Your order has been placed.","success")}catch(a){console.error("Checkout error:",a),r("❌ Something went wrong, please try again.","error")}}),x()});